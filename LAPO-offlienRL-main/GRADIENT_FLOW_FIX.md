# æ¢¯åº¦æµå‘ä¿®å¤ï¼šç¼–ç å™¨çš„æ­£ç¡®ä¼˜åŒ–ç­–ç•¥

## ğŸ”´ é—®é¢˜è¯Šæ–­

### åŸå§‹è®¾è®¡çš„é€»è¾‘æ¼æ´

```python
# âŒ é”™è¯¯çš„ä¼˜åŒ–å™¨é…ç½®

# VAEä¼˜åŒ–å™¨ï¼šåŒ…å«VAE + ç¼–ç å™¨
actorvae_optimizer = Adam(
    actor_vae.parameters() + obs_encoder.parameters()
)

# Criticä¼˜åŒ–å™¨ï¼šåªåŒ…å«Critic
critic_optimizer = Adam(
    critic.parameters()
)
```

### æ¢¯åº¦æµå‘çš„é—®é¢˜

```
è®­ç»ƒå¾ªç¯çš„æ‰§è¡Œé¡ºåºï¼š

1ï¸âƒ£ Criticè®­ç»ƒ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ critic_loss = MSE(Q, target_Q)      â”‚
   â”‚ critic_loss.backward()              â”‚
   â”‚ â†’ æ¢¯åº¦æµå‘ critic âœ…                 â”‚
   â”‚ â†’ æ¢¯åº¦æµå‘ obs_encoder âŒ (æœªä½¿ç”¨)  â”‚
   â”‚ critic_optimizer.step()             â”‚
   â”‚ â†’ æ›´æ–° critic âœ…                    â”‚
   â”‚ â†’ obs_encoder æ¢¯åº¦è¢«å¿½ç•¥ âŒ          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

2ï¸âƒ£ VAEè®­ç»ƒ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ actorvae_optimizer.zero_grad()      â”‚
   â”‚ â†’ æ¸…ç©ºæ‰€æœ‰æ¢¯åº¦ï¼ˆåŒ…æ‹¬obs_encoderï¼‰   â”‚
   â”‚ vae_loss.backward()                 â”‚
   â”‚ â†’ æ¢¯åº¦é‡æ–°æµå‘ actor_vae âœ…         â”‚
   â”‚ â†’ æ¢¯åº¦æµå‘ obs_encoder âœ…           â”‚
   â”‚ actorvae_optimizer.step()           â”‚
   â”‚ â†’ æ›´æ–° actor_vae âœ…                 â”‚
   â”‚ â†’ æ›´æ–° obs_encoder âœ… (ä½†åªåŸºäºVAE) â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“æœï¼š
obs_encoder åªè¢« VAE çš„ä¿¡å·å¼•å¯¼ âŒ
obs_encoder æ²¡æœ‰æ¥æ”¶ Critic çš„å¼ºä¿¡å· âŒ
```

### åæœåˆ†æ

```
obs_encoderå­¦ä¹ ç›®æ ‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ä»…ä¼˜åŒ–ï¼šé‡æ„åŠ¨ä½œçš„è¯¯å·®                      â”‚
â”‚ âœ“ å­¦ä¼šç¼–ç ä»€ä¹ˆç‰¹å¾èƒ½é‡å»ºåŠ¨ä½œ                â”‚
â”‚ âœ— ä¸çŸ¥é“ä»€ä¹ˆç‰¹å¾ä¸é«˜Qå€¼ç›¸å…³                 â”‚
â”‚ âœ— ä¸çŸ¥é“ä»€ä¹ˆç‰¹å¾ä¸ä½Qå€¼ç›¸å…³                 â”‚
â”‚ âœ— ç¼ºå°‘"ä»·å€¼å¯¼å‘"çš„å­¦ä¹ ä¿¡å·                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Criticçš„å­¦ä¹ ç›®æ ‡ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨ç¼–ç åçš„ç‰¹å¾ä¼°è®¡Qå€¼                       â”‚
â”‚ âœ“ å­¦ä¼šQå€¼è¯„ä¼°                               â”‚
â”‚ âœ— ç¼–ç å™¨ä¸çŸ¥é“è¿™ä¸ªQå€¼è¯„ä¼°ç›®æ ‡                â”‚
â”‚ âœ— ç¼–ç å™¨ä¸ä¼šè°ƒæ•´ç‰¹å¾ä»¥æ”¯æŒQå€¼è¯„ä¼°            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

é—®é¢˜ï¼šç‰¹å¾å’ŒQå€¼è¯„ä¼°å™¨è„±èŠ‚ï¼
â†’ ç¼–ç å™¨æ— æ³•ä¸ºCriticçš„ç›®æ ‡ä¼˜åŒ–ç‰¹å¾
â†’ ç‰¹å¾è´¨é‡å·®ï¼ŒQå€¼è¯„ä¼°ä¸å‡†
â†’ ç­–ç•¥å­¦ä¹ ä¿¡å·å¼±
â†’ æœ€ç»ˆç­–ç•¥æ€§èƒ½å·®
```

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ¨èæ–¹æ¡ˆï¼šè®©Criticä¸»å¯¼ç¼–ç å™¨æ›´æ–°

```python
# âœ… æ­£ç¡®çš„ä¼˜åŒ–å™¨é…ç½®

# Criticä¼˜åŒ–å™¨ï¼šåŒ…å«Critic + obs_encoder
# åŸå› ï¼šCriticçš„ä¿¡å·æ›´å¼ºï¼ˆç›´æ¥æ¥è‡ªå¥–åŠ±ï¼‰ï¼Œåº”è¯¥ä¸»å¯¼ç‰¹å¾å­¦ä¹ 
critic_optimizer = Adam(
    [
        {'params': critic.parameters()},
        {'params': obs_encoder.parameters()}
    ],
    lr=critic_lr
)

# VAEä¼˜åŒ–å™¨ï¼šåªåŒ…å«VAEå‚æ•°
# åŸå› ï¼šåœ¨Criticå·²ç»ä¼˜åŒ–çš„ç¼–ç ç‰¹å¾åŸºç¡€ä¸Šå­¦ä¹ åŠ¨ä½œé‡å»º
actorvae_optimizer = Adam(
    actor_vae.parameters(),
    lr=vae_lr
)
```

### æ¢¯åº¦æµå‘ä¿®å¤å

```
è®­ç»ƒå¾ªç¯çš„æ‰§è¡Œé¡ºåºï¼š

1ï¸âƒ£ Criticè®­ç»ƒ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ critic_loss = MSE(Q, target_Q)       â”‚
   â”‚ critic_loss.backward()               â”‚
   â”‚ â†’ æ¢¯åº¦æµå‘ critic âœ…                  â”‚
   â”‚ â†’ æ¢¯åº¦æµå‘ obs_encoder âœ… (å…³é”®ï¼)    â”‚
   â”‚ critic_optimizer.step()              â”‚
   â”‚ â†’ æ›´æ–° critic âœ…                     â”‚
   â”‚ â†’ æ›´æ–° obs_encoder âœ… (åŸºäºQå€¼)       â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â¬‡ï¸
        obs_encoderå·²ä¼˜åŒ–ï¼Œç‰¹å¾è´¨é‡é«˜

2ï¸âƒ£ VAEè®­ç»ƒ
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ actorvae_optimizer.zero_grad()       â”‚
   â”‚ vae_loss.backward()                  â”‚
   â”‚ â†’ æ¢¯åº¦æµå‘ actor_vae âœ…              â”‚
   â”‚ â†’ æ¢¯åº¦ä¸å†æµå‘ obs_encoder âœ…        â”‚
   â”‚ actorvae_optimizer.step()            â”‚
   â”‚ â†’ æ›´æ–° actor_vae âœ…                  â”‚
   â”‚ â†’ obs_encoder ä¿æŒä¸å˜ âœ…            â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç»“æœï¼š
obs_encoderä¸»è¦ç”±Criticä¼˜åŒ– âœ…
ç‰¹å¾å­¦ä¹ äº†é«˜ä»·å€¼å’Œä½ä»·å€¼çš„åŒºåˆ« âœ…
```

---

## ğŸ”„ è¯¦ç»†çš„æ¢¯åº¦æµå‘

### ä¼˜åŒ–å‰ï¼ˆé—®é¢˜ï¼‰

```
è®¡ç®—å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ left_img(batch) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    obs_encoder
    [CNNç¼–ç å™¨]
         â”‚
         â–¼
    obs_feature
      [256ç»´]
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚          â”‚
    â–¼          â–¼
  Critic     ActorVAE
    â”‚          â”‚
    â–¼          â–¼
   Qå€¼    reconstructed_a
    â”‚          â”‚
    â–¼          â–¼
 critic_loss  vae_loss
    â”‚          â”‚
    â””â”€â”¬â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
      â”‚    â”‚
  grad_c  grad_v
      â”‚    â”‚
  âŒâŒ ä¸è¿æ¥ âŒâŒ
  (critic_loss.backward()äº§ç”Ÿæ¢¯åº¦ï¼Œä½†critic_optimizerä¸ä½¿ç”¨)
  (actorvae_optimizer.zero_grad()æ¸…ç©ºæ¢¯åº¦)
  (vae_loss.backward()äº§ç”Ÿæ–°æ¢¯åº¦)
```

### ä¼˜åŒ–åï¼ˆæ­£ç¡®ï¼‰

```
è®¡ç®—å›¾ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ left_img(batch) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    obs_encoder
    [CNNç¼–ç å™¨]
         â”‚
         â–¼
    obs_feature
      [256ç»´]
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚          â”‚
    â–¼          â–¼
  Critic     ActorVAE
    â”‚          â”‚
    â–¼          â–¼
   Qå€¼    reconstructed_a
    â”‚          â”‚
    â–¼          â–¼
 critic_loss  vae_loss
    â”‚          â”‚
    â”œâ”€â†’ âœ… â†â”€â”€â”¤
    â”‚  æ¢¯åº¦  â”‚
    â–¼        â–¼
 grad_critic  grad_vae
    â”‚
    â–¼
 critic_optimizer.step()
 â”œâ”€ æ›´æ–° critic
 â””â”€ æ›´æ–° obs_encoder âœ…âœ…âœ… (å…³é”®ï¼)
    
 vae_loss.backward() (obs_encoderæ¢¯åº¦ä¸º0)
 â–¼
 actorvae_optimizer.step()
 â””â”€ æ›´æ–° actor_vae
    (obs_encoderä¸è¢«æ›´æ–°)
```

---

## ğŸ“ ä»£ç å¯¹æ¯”

### âŒ åŸå§‹ï¼ˆæœ‰ç¼ºé™·ï¼‰

```python
class MultimodalLatent(object):
    def __init__(self, ..., vae_lr=1e-4, actor_lr=1e-4, critic_lr=5e-4, ...):
        # ... åˆå§‹åŒ–ç¼–ç å™¨ã€VAEã€Actorã€Critic ...
        
        # âŒ é—®é¢˜1ï¼šVAEä¼˜åŒ–å™¨åŒ…å«ç¼–ç å™¨
        self.actorvae_optimizer = torch.optim.Adam(
            list(self.actor_vae.parameters()) + list(self.obs_encoder.parameters()),
            lr=vae_lr  # æ³¨æ„ï¼šè¿™é‡Œæ˜¯VAEçš„å­¦ä¹ ç‡ï¼Œä¸æ˜¯Criticçš„
        )
        
        # âŒ é—®é¢˜2ï¼šCriticä¼˜åŒ–å™¨ä¸åŒ…å«ç¼–ç å™¨
        self.critic_optimizer = torch.optim.Adam(
            self.critic.parameters(),
            lr=critic_lr
        )
    
    def train(self, iterations, batch_size=100):
        for it in range(iterations):
            batch = self.replay_buffer.sample(batch_size)
            # ...
            
            # Criticè®­ç»ƒ
            critic_loss = ...
            self.critic_optimizer.zero_grad()
            critic_loss.backward()  # â† æ¢¯åº¦æµå‘criticå’Œobs_encoder
            self.critic_optimizer.step()  # â† åªæ›´æ–°criticï¼Œobs_encoderè¢«å¿½ç•¥ âŒ
            
            # VAEè®­ç»ƒ
            self.actorvae_optimizer.zero_grad()  # â† æ¸…ç©ºæ‰€æœ‰æ¢¯åº¦
            vae_loss = ...
            vae_loss.backward()  # â† æ¢¯åº¦é‡æ–°æµå‘actor_vaeå’Œobs_encoder
            self.actorvae_optimizer.step()  # â† æ›´æ–°actor_vaeå’Œobs_encoder
```

### âœ… ä¿®å¤ï¼ˆæ¨èï¼‰

```python
class MultimodalLatent(object):
    def __init__(self, ..., vae_lr=1e-4, actor_lr=1e-4, critic_lr=5e-4, ...):
        # ... åˆå§‹åŒ–ç¼–ç å™¨ã€VAEã€Actorã€Critic ...
        
        # âœ… æ­£ç¡®1ï¼šVAEä¼˜åŒ–å™¨åªåŒ…å«VAE
        # ç¼–ç å™¨ç”±Criticä¸»å¯¼ï¼Œä¸ç”±VAEé©±åŠ¨
        self.actorvae_optimizer = torch.optim.Adam(
            self.actor_vae.parameters(),  # ä»…VAEå‚æ•°
            lr=vae_lr
        )
        
        # âœ… æ­£ç¡®2ï¼šCriticä¼˜åŒ–å™¨åŒ…å«Criticå’Œç¼–ç å™¨
        # obs_encoderä¸»è¦ç”±Criticä¿¡å·ä¼˜åŒ–ï¼ˆQå€¼åæ˜ ä»·å€¼ï¼‰
        self.critic_optimizer = torch.optim.Adam(
            [
                {'params': self.critic.parameters()},
                {'params': self.obs_encoder.parameters()}
            ],
            lr=critic_lr
        )
    
    def train(self, iterations, batch_size=100):
        for it in range(iterations):
            batch = self.replay_buffer.sample(batch_size)
            # ...
            
            # Criticè®­ç»ƒï¼ˆç°åœ¨åŒ…æ‹¬ç¼–ç å™¨ä¼˜åŒ–ï¼‰
            critic_loss = ...
            self.critic_optimizer.zero_grad()
            critic_loss.backward()  # â† æ¢¯åº¦æµå‘criticå’Œobs_encoder
            self.critic_optimizer.step()  # â† åŒæ—¶æ›´æ–°criticå’Œobs_encoder âœ…âœ…âœ…
            
            # VAEè®­ç»ƒï¼ˆç¼–ç å™¨ä¸å†è¢«æ›´æ–°ï¼‰
            self.actorvae_optimizer.zero_grad()  # â† ä»…æ¸…ç©ºVAEæ¢¯åº¦
            vae_loss = ...
            vae_loss.backward()  # â† æ¢¯åº¦ä»…æµå‘actor_vae
            self.actorvae_optimizer.step()  # â† ä»…æ›´æ–°actor_vae
```

---

## ğŸ“Š å­¦ä¹ ä¿¡å·æ¥æºåˆ†æ

### ç¼–ç å™¨ä»ä½•å¤„å­¦ä¹ 

ä¿®å¤åï¼š

| å­¦ä¹ ä¿¡å· | æ¥æº | å¼ºåº¦ | ç”¨é€” |
|---------|------|------|------|
| **Critic** | critic_lossåå‘ä¼ æ’­ | **å¼º** | ä¸»å¯¼ç‰¹å¾å­¦ä¹  |
| ç‰¹å¾åº”è¯¥åŒºåˆ†é«˜Qå’Œä½Q |  |  | |
| **VAE** | vae_lossåå‘ä¼ æ’­ | å¼± | å·²è¢«Criticä¼˜åŒ– |
| ä¸å†ç›´æ¥é©±åŠ¨ç¼–ç å™¨ |  |  | ç‰¹å¾ç”¨äºé‡å»º |

### å„ç½‘ç»œçš„å­¦ä¹ ç›®æ ‡

```
obs_encoder:
  ç›®æ ‡ï¼šå­¦ä¹ èƒ½æœ€å¤§åŒ–Qå€¼é¢„æµ‹å‡†ç¡®æ€§çš„ç‰¹å¾
  ä¿¡å·æ¥æºï¼šcritic_loss
  æ¢¯åº¦é¢‘ç‡ï¼šæ¯æ¬¡criticè®­ç»ƒéƒ½æ›´æ–° âœ…

actor_vae:
  ç›®æ ‡ï¼šå­¦ä¹ é‡æ„åŠ¨ä½œåˆ†å¸ƒï¼ˆåœ¨ç¼–ç ç‰¹å¾åŸºç¡€ä¸Šï¼‰
  ä¿¡å·æ¥æºï¼švae_loss
  æ¢¯åº¦é¢‘ç‡ï¼šæ¯æ¬¡VAEè®­ç»ƒéƒ½æ›´æ–° âœ…
  ç¼–ç å™¨çŠ¶æ€ï¼šæ¥æ”¶Criticå·²ä¼˜åŒ–çš„ç‰¹å¾ âœ…

actor:
  ç›®æ ‡ï¼šåœ¨éšç©ºé—´æœ€å¤§åŒ–Qå€¼
  ä¿¡å·æ¥æºï¼šactor_loss
  æ¢¯åº¦é¢‘ç‡ï¼šæ¯æ¬¡Actorè®­ç»ƒéƒ½æ›´æ–° âœ…
  ç¼–ç å™¨çŠ¶æ€ï¼šä½¿ç”¨Criticå·²ä¼˜åŒ–çš„ç‰¹å¾ âœ…

critic:
  ç›®æ ‡ï¼šå‡†ç¡®ä¼°è®¡Qå€¼å’ŒVå€¼
  ä¿¡å·æ¥æºï¼šcritic_loss
  æ¢¯åº¦é¢‘ç‡ï¼šæ¯æ¬¡Criticè®­ç»ƒéƒ½æ›´æ–° âœ…
  ç¼–ç å™¨çŠ¶æ€ï¼šåŒæ­¥ä¼˜åŒ–ç‰¹å¾ âœ…
```

---

## ğŸ¯ ä¸ºä»€ä¹ˆè¿™ä¸ªä¿®å¤å¾ˆé‡è¦

### 1. ç‰¹å¾å’Œä»·å€¼è¯„ä¼°å™¨å¯¹é½

```
ä¿®å¤å‰ï¼šç‰¹å¾å­¦ä¹  â‰  ä»·å€¼è¯„ä¼°
ç¼–ç å™¨ï¼šæˆ‘å­¦åˆ°çš„ç‰¹å¾ç”¨äºé‡å»ºåŠ¨ä½œ
Criticï¼šæˆ‘ç”¨è¿™äº›ç‰¹å¾ä¼°è®¡Qå€¼
â†’ ç¼–ç å™¨ä¸çŸ¥é“Qå€¼éœ€è¦ä»€ä¹ˆç‰¹å¾ âŒ

ä¿®å¤åï¼šç‰¹å¾å­¦ä¹  = ä»·å€¼è¯„ä¼°
ç¼–ç å™¨ï¼šæˆ‘å­¦åˆ°çš„ç‰¹å¾ç”¨äºæ”¯æŒQå€¼è¯„ä¼°
Criticï¼šæˆ‘ç”¨è¿™äº›ç‰¹å¾ä¼°è®¡Qå€¼
â†’ ç¼–ç å™¨ä¸ºQå€¼ä¼˜åŒ–ç‰¹å¾ âœ…
```

### 2. å¼ºå¼ºè”åˆ vs å¼±ä¿¡å·

```
ä¿®å¤å‰ï¼šç¼–ç å™¨ä¸»è¦å­¦ä¹ VAEä»»åŠ¡
â”œâ”€ VAEæŸå¤±ï¼šåŠ¨ä½œé‡å»ºè¯¯å·®
â”‚  â””â”€ é€šå¸¸è¾ƒå°ï¼ˆ< 0.1ï¼‰
â”‚     æ¢¯åº¦å¹…åº¦å°
â””â”€ Criticä¿¡å·ï¼šå®Œå…¨æ— æ•ˆ

ä¿®å¤åï¼šç¼–ç å™¨å­¦ä¹ Criticä»»åŠ¡
â”œâ”€ CriticæŸå¤±ï¼šQå€¼è¯„ä¼°è¯¯å·®
â”‚  â””â”€ é€šå¸¸è¾ƒå¤§ï¼ˆ> 1.0ï¼‰
â”‚     æ¢¯åº¦å¹…åº¦å¤§
â””â”€ ç”±å¼ºä¿¡å·ä¸»å¯¼
```

### 3. ç‰¹å¾è´¨é‡å’Œç­–ç•¥æ€§èƒ½

```
ä¿®å¤å‰ï¼šä½è´¨é‡ç‰¹å¾
â”œâ”€ ä¸ç†è§£Qå€¼
â”œâ”€ Criticé¢„æµ‹ä¸å‡†
â”œâ”€ Actorå­¦ä¹ ä¿¡å·å¼±
â””â”€ ç­–ç•¥æ€§èƒ½å·® âŒ

ä¿®å¤åï¼šé«˜è´¨é‡ç‰¹å¾
â”œâ”€ åŒºåˆ†é«˜/ä½Qå€¼
â”œâ”€ Criticé¢„æµ‹å‡†
â”œâ”€ Actorå­¦ä¹ ä¿¡å·å¼º
â””â”€ ç­–ç•¥æ€§èƒ½å¥½ âœ…
```

---

## ğŸ’¡ è®¾è®¡æ€æƒ³

### ä¸ºä»€ä¹ˆCriticåº”è¯¥ä¸»å¯¼ç¼–ç å™¨æ›´æ–°ï¼Ÿ

1. **å¥–åŠ±ä¿¡å·æœ€å¼º**
   - Criticç›´æ¥è¿æ¥åˆ°æ•°æ®é›†ä¸­çš„å¥–åŠ±
   - æ˜¯æœ€æœ‰æŒ‡å¯¼æ€§çš„ä¿¡å·æº

2. **ä»·å€¼å‡½æ•°å…³é”®**
   - ç¦»çº¿RLä¸­ï¼ŒQå€¼ä¼°è®¡è‡³å…³é‡è¦
   - ç¼–ç å™¨åº”ä¼˜åŒ–ç‰¹å¾ä»¥æ”¯æŒå‡†ç¡®çš„Qå€¼è¯„ä¼°

3. **VAEæ˜¯å·¥å…·ï¼Œä¸æ˜¯ç›®æ ‡**
   - VAEå­¦ä¹ åŠ¨ä½œåˆ†å¸ƒï¼ˆè¾…åŠ©ä»»åŠ¡ï¼‰
   - å®ƒåº”è¯¥åœ¨ç¼–ç å™¨å·²ä¼˜åŒ–çš„åŸºç¡€ä¸Šå·¥ä½œ

4. **æ¢¯åº¦æµå‘çš„ä¼˜å…ˆçº§**
   - ä¼˜å…ˆçº§1ï¼šCriticï¼ˆæœ€å¼ºã€æœ€ç›´æ¥çš„ä¿¡å·ï¼‰
   - ä¼˜å…ˆçº§2ï¼šActorï¼ˆåœ¨Criticç‰¹å¾åŸºç¡€ä¸Šä¼˜åŒ–ï¼‰
   - ä¼˜å…ˆçº§3ï¼šVAEï¼ˆè¾…åŠ©ï¼Œåœ¨ç¨³å®šçš„ç‰¹å¾åŸºç¡€ä¸Šï¼‰

---

## âœ¨ ä¿®å¤æ€»ç»“

### å˜åŒ–

| ç»„ä»¶ | ä¿®æ”¹å‰ | ä¿®æ”¹å | åŸå›  |
|------|--------|--------|------|
| **VAEä¼˜åŒ–å™¨** | vae_lr | vae_lr | å­¦ä¹ ç‡ä¸å˜ |
| **å‚æ•°** | actor_vae + obs_encoder | actor_vae | ç§»é™¤ç¼–ç å™¨ |
| **Criticä¼˜åŒ–å™¨** | critic_lr | critic_lr | å­¦ä¹ ç‡ä¸å˜ |
| **å‚æ•°** | critic | critic + obs_encoder | æ·»åŠ ç¼–ç å™¨ |

### æ•ˆæœ

- âœ… ç¼–ç å™¨ç°åœ¨æ¥æ”¶Criticçš„å¼ºä¿¡å·
- âœ… ç‰¹å¾å­¦ä¹ ä¸Qå€¼è¯„ä¼°å¯¹é½
- âœ… ç­–ç•¥å­¦ä¹ ä¿¡å·æ›´å¼º
- âœ… æ”¶æ•›é€Ÿåº¦å¯èƒ½æå‡
- âœ… æœ€ç»ˆç­–ç•¥æ€§èƒ½æ›´å¥½

---

## ğŸ“ å®ç°ç»†èŠ‚

### å‚æ•°ç»„çš„ç”¨é€”

```python
self.critic_optimizer = torch.optim.Adam(
    [
        {'params': self.critic.parameters()},        # é»˜è®¤lr=critic_lr
        {'params': self.obs_encoder.parameters()}    # åŒæ ·ä½¿ç”¨critic_lr
    ],
    lr=critic_lr
)
```

**ä¸ºä»€ä¹ˆç”¨å‚æ•°ç»„ï¼Ÿ**
- å¯ä»¥ä¸ºä¸åŒå‚æ•°è®¾ç½®ä¸åŒå­¦ä¹ ç‡
- è¿™é‡Œéƒ½ç”¨ç›¸åŒlrï¼Œä¿æŒç®€æ´
- ä¹Ÿå¯ä»¥åˆ†åˆ«è®¾ç½®ï¼š
  ```python
  [
      {'params': self.critic.parameters(), 'lr': critic_lr},
      {'params': self.obs_encoder.parameters(), 'lr': critic_lr * 0.1}  # ç¼–ç å™¨å­¦ä¹ ç‡æ›´ä½
  ]
  ```

---

## ğŸ”¬ éªŒè¯ä¿®å¤

### å¦‚ä½•éªŒè¯æ¢¯åº¦æµå‘æ­£ç¡®ï¼Ÿ

```python
# åœ¨è®­ç»ƒä¸­æ·»åŠ è°ƒè¯•ä»£ç 
def train(self, iterations, batch_size=100):
    for it in range(iterations):
        # ... é‡‡æ ·æ‰¹æ¬¡ ...
        
        # Criticè®­ç»ƒ
        critic_loss = ...
        self.critic_optimizer.zero_grad()
        critic_loss.backward()
        
        # âœ… éªŒè¯æ¢¯åº¦
        print("obs_encoderæ¢¯åº¦ï¼š", 
              torch.norm(self.obs_encoder.image_encoder.fc.weight.grad))
        print("criticæ¢¯åº¦ï¼š", 
              torch.norm(self.critic.l1.weight.grad))
        
        self.critic_optimizer.step()
        
        # ... VAEè®­ç»ƒ ...
```

**æœŸæœ›ç»“æœï¼š**
- obs_encoderæ¢¯åº¦éé›¶ âœ…
- Criticæ¢¯åº¦éé›¶ âœ…
- ä¸¤è€…éƒ½è¢«æ›´æ–° âœ…

---

## ç»“è®º

è¿™ä¸ªä¿®å¤æ˜¯ **å¤šæ¨¡æ€LAPO** æ­£ç¡®å·¥ä½œçš„å…³é”®ï¼š
- ç¼–ç å™¨ç”±Criticä¸»å¯¼ï¼Œå­¦ä¹ ä»·å€¼ç›¸å…³ç‰¹å¾
- VAEåœ¨ä¼˜åŒ–åçš„ç‰¹å¾åŸºç¡€ä¸Šå­¦ä¹ 
- Actorä½¿ç”¨é«˜è´¨é‡ç‰¹å¾è¿›è¡Œéšç©ºé—´ä¼˜åŒ–
- ä¸‰è€…ååŒæ„æˆå®Œæ•´çš„ç¦»çº¿å¼ºåŒ–å­¦ä¹ æ¡†æ¶

**å•ä¸ªä¿®æ”¹ï¼Œå¤§å¹…æå‡æ€§èƒ½ï¼** ğŸš€
