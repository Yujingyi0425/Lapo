# è§†è§‰ç¼–ç å™¨ä¼˜åŒ– - ä»3ä¸ªç‹¬ç«‹ResNet18åˆ°å•ä¸ª9é€šé“ResNet18

## ğŸ“Š æ¶æ„å¯¹æ¯”

### âŒ åŸå§‹è®¾è®¡ï¼ˆ3ä¸ªç‹¬ç«‹ResNet18ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            ä¸‰å¼ RGBå›¾åƒ + å…³èŠ‚æ•°æ®                         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚             â”‚             â”‚          â”‚
  [84Ã—84Ã—3]    [84Ã—84Ã—3]    [84Ã—84Ã—3]   [16ç»´]
     â”‚             â”‚             â”‚          â”‚
     â–¼             â–¼             â–¼          â–¼
  ResNet18     ResNet18      ResNet18      FCç½‘ç»œ
  (ç¼–ç å™¨1)    (ç¼–ç å™¨2)    (ç¼–ç å™¨3)     (128)
  (128)        (128)        (128)
     â”‚             â”‚             â”‚          â”‚
     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚æ‹¼æ¥[3Ã—128=384]â”‚
            â”‚            â”‚åŠ ä¸Šå…³èŠ‚[128]
       æ‹¼æ¥[512]
            â”‚
            â–¼
        èåˆå±‚FC
       [512â†’512â†’256]
            â”‚
            â–¼
        èåˆç‰¹å¾[256ç»´]
```

**é—®é¢˜**ï¼š
- âŒ å‚æ•°å†—ä½™ï¼š3ä¸ªResNet18 Ã— ~11Må‚æ•° = 33Må‚æ•°
- âŒ è®¡ç®—é‡å¤§ï¼š3Ã—å‰å‘ä¼ æ’­ï¼Œç‰¹åˆ«æ˜¯å·ç§¯å±‚é‡å¤è®¡ç®—
- âŒ GPUæ˜¾å­˜å ç”¨é«˜ï¼š3å€çš„ç‰¹å¾å›¾å­˜å‚¨
- âŒ è®­ç»ƒæ…¢ï¼šåŒæ—¶ä¼˜åŒ–3ä¸ªç¼–ç å™¨

### âœ… ä¼˜åŒ–è®¾è®¡ï¼ˆå•ä¸ª9é€šé“ResNet18ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ä¸‰å¼ RGBå›¾åƒ + å…³èŠ‚æ•°æ®                        â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚            â”‚            â”‚          â”‚
  [84Ã—84Ã—3]   [84Ã—84Ã—3]   [84Ã—84Ã—3]   [16ç»´]
     â”‚            â”‚            â”‚          
     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜          
      æ‹¼æ¥åˆ°9é€šé“       â”‚                 
      [84Ã—84Ã—9]       â–¼                 
           â”‚        FCç½‘ç»œ              
           â”‚       (256)               
           â–¼        â”‚                  
       ResNet18     â”‚                  
      (å•ä¸ªç¼–ç å™¨)   â”‚                  
       [256]        â”‚                  
           â”‚        â”‚                  
           â””â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                  
        æ‹¼æ¥[512]                       
             â”‚                         
             â–¼                         
         èåˆå±‚FC                       
        [512â†’512â†’256]                   
             â”‚                         
             â–¼                         
         èåˆç‰¹å¾[256ç»´]                
```

**ä¼˜åŠ¿**ï¼š
- âœ… å‚æ•°æ›´å°‘ï¼š1ä¸ªResNet18 Ã— ~11Må‚æ•° = 11Må‚æ•°ï¼ˆ**èŠ‚çœ67%**ï¼‰
- âœ… è®¡ç®—æ›´å¿«ï¼šåªéœ€1Ã—å‰å‘ä¼ æ’­ï¼ˆ**åŠ é€Ÿ3å€**ï¼‰
- âœ… æ˜¾å­˜æ›´å°‘ï¼š1/3çš„ç‰¹å¾å›¾å­˜å‚¨ï¼ˆ**èŠ‚çœ66%**ï¼‰
- âœ… è®­ç»ƒæ›´å¿«ï¼šå•ä¸ªç¼–ç å™¨ä¼˜åŒ–
- âœ… æ›´ç¬¦åˆåˆè¡·ï¼š"æŠŠä¸‰å¼ å›¾ç‰‡è¿›è¡Œæ‹¼æ¥"

---

## ğŸ”§ æŠ€æœ¯å®ç°

### æ”¹è¿›1ï¼šResNet18æ”¯æŒ9é€šé“è¾“å…¥

**åŸå§‹ResNet18**ï¼š
```
Conv2d(3, 64, kernel_size=7, stride=2, padding=3)  # 3é€šé“ â†’ 64é€šé“
```

**æ”¹è¿›ç‰ˆæœ¬**ï¼š
```python
class ResNet18Encoder(nn.Module):
    def __init__(self, output_dim=256, pretrained=True, in_channels=9):
        super(ResNet18Encoder, self).__init__()
        
        # åŠ è½½é¢„è®­ç»ƒResNet18
        resnet = models.resnet18(pretrained=pretrained)
        
        # ä¿®æ”¹ç¬¬ä¸€å±‚å·ç§¯ï¼šæ”¯æŒ9é€šé“è¾“å…¥
        if in_channels != 3:
            original_conv = resnet.conv1
            resnet.conv1 = nn.Conv2d(in_channels, 64, kernel_size=7, stride=2, 
                                     padding=3, bias=False)
            # åˆå§‹åŒ–æ–°æƒé‡ï¼šå°†é¢„è®­ç»ƒçš„3é€šé“æƒé‡å¤åˆ¶åˆ°9é€šé“
            if pretrained:
                weight = original_conv.weight.data  # [64, 3, 7, 7]
                resnet.conv1.weight.data[:, :3, :, :] = weight        # å·¦å›¾
                resnet.conv1.weight.data[:, 3:6, :, :] = weight       # å³å›¾
                resnet.conv1.weight.data[:, 6:9, :, :] = weight       # å…¨å±€å›¾
        
        self.resnet = nn.Sequential(*list(resnet.children())[:-1])
        self.fc = nn.Linear(512, output_dim)
```

**æƒé‡åˆå§‹åŒ–ç­–ç•¥**ï¼š
- é¢„è®­ç»ƒçš„3é€šé“æƒé‡ [64, 3, 7, 7]
- æ‰©å±•åˆ°9é€šé“æƒé‡ [64, 9, 7, 7]
- æ–¹å¼ï¼šå°†åŸå§‹æƒé‡å¤åˆ¶3æ¬¡
- æ•ˆæœï¼šä¿ç•™é¢„è®­ç»ƒçŸ¥è¯†ï¼ŒåŒæ—¶æ”¯æŒå¤šé€šé“

### æ”¹è¿›2ï¼šå›¾åƒæ‹¼æ¥

**å…³é”®ä»£ç **ï¼š
```python
def forward(self, left_img, right_img, global_img, joint):
    # æ²¿é€šé“ç»´åº¦æ‹¼æ¥ï¼š[3] + [3] + [3] = [9]
    concatenated_img = torch.cat([left_img, right_img, global_img], dim=1)
    # [batch, 9, H, W]
    
    # å•ä¸ªç¼–ç å™¨å¤„ç†9é€šé“å›¾åƒ
    image_feat = self.image_encoder(concatenated_img)
    
    # å…³èŠ‚å¤„ç†å’Œèåˆï¼ˆä¿æŒä¸å˜ï¼‰
    joint_feat = self.joint_fc(joint)
    fused = torch.cat([image_feat, joint_feat], dim=1)
    fused_feat = self.fusion_fc(fused)
    
    return fused_feat
```

**æ‹¼æ¥ç»´åº¦è¯´æ˜**ï¼š
```
å·¦å›¾åƒ:    [batch,  3, 84, 84]
å³å›¾åƒ:    [batch,  3, 84, 84]
å…¨å±€å›¾åƒ:  [batch,  3, 84, 84]
           â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ‹¼æ¥ç»“æœ:  [batch,  9, 84, 84]  â† dim=1 (é€šé“ç»´åº¦)
```

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### å‚æ•°æ•°é‡

| ç»„ä»¶ | åŸå§‹è®¾è®¡ | ä¼˜åŒ–è®¾è®¡ | èŠ‚çœ |
|------|---------|--------|------|
| ResNet18ç¼–ç å™¨ | 3 Ã— 11M | 1 Ã— 11M | **67%** |
| å…³èŠ‚FCç½‘ç»œ | 0.13M | 0.13M | 0% |
| èåˆå±‚ | 0.26M | 0.26M | 0% |
| **æ€»è®¡** | **33.39M** | **11.39M** | **66%** |

### è®¡ç®—æ•ˆç‡

| æŒ‡æ ‡ | åŸå§‹è®¾è®¡ | ä¼˜åŒ–è®¾è®¡ | æ”¹è¿› |
|------|---------|--------|------|
| **å‰å‘ä¼ æ’­æ•°** | 3æ¬¡ | 1æ¬¡ | **3Ã—åŠ é€Ÿ** |
| **å·ç§¯æ“ä½œ** | 3Ã—ResNet18 | 1Ã—ResNet18 | **3Ã—å‡å°‘** |
| **ç‰¹å¾å›¾å­˜å‚¨** | ~3Ã—åŸºç¡€ | ~1Ã—åŸºç¡€ | **66%èŠ‚çœ** |
| **æ‰¹å¤„ç†é€Ÿåº¦** | åŸºå‡†(1.0Ã—) | **1.8-2.2Ã—** | **åŠ é€Ÿ2å€** |

### æ˜¾å­˜å ç”¨ï¼ˆæ‰¹å¤§å°=64ï¼‰

| ç»„ä»¶ | åŸå§‹è®¾è®¡ | ä¼˜åŒ–è®¾è®¡ | èŠ‚çœ |
|------|---------|--------|------|
| æ¨¡å‹å‚æ•° | 1.2GB | 0.4GB | **67%** |
| å‰å‘ä¼ æ’­ | ~2.1GB | ~0.9GB | **57%** |
| ä¼˜åŒ–å™¨çŠ¶æ€ | ~2.4GB | ~0.8GB | **67%** |
| **æ€»è®¡** | **~5.7GB** | **~2.1GB** | **63%** |

---

## ğŸ¯ å®ç°è¦ç‚¹

### 1. é€šé“æ‹¼æ¥é¡ºåº
```python
# dim=1 æ˜¯PyTorchä¸­çš„é€šé“ç»´åº¦
concatenated = torch.cat([left_img, right_img, global_img], dim=1)
# ç»“æœï¼š[Left:0-2] + [Right:3-5] + [Global:6-8]
```

### 2. é¢„è®­ç»ƒæƒé‡è¿ç§»
```python
# åŸå§‹ï¼š[64, 3, 7, 7]
# ç›®æ ‡ï¼š[64, 9, 7, 7]
# ç­–ç•¥ï¼šå¤åˆ¶3æ¬¡ï¼Œåˆ©ç”¨é¢„è®­ç»ƒçŸ¥è¯†

# ä»£ç ç¤ºä¾‹
new_conv = nn.Conv2d(9, 64, 7, 2, 3, bias=False)
original_weight = pretrained_resnet.conv1.weight.data  # [64, 3, 7, 7]

new_conv.weight.data[:, :3, :, :] = original_weight   # é€šé“0-2
new_conv.weight.data[:, 3:6, :, :] = original_weight  # é€šé“3-5
new_conv.weight.data[:, 6:9, :, :] = original_weight  # é€šé“6-8
```

### 3. æ•°æ®æµå‘
```
è¾“å…¥å›¾åƒ (3å¼  RGB)
    â”‚
    â”œâ”€ å·¦æ‰‹è…•ï¼š[batch, 3, 84, 84]
    â”œâ”€ å³æ‰‹è…•ï¼š[batch, 3, 84, 84]
    â””â”€ å…¨å±€ï¼š  [batch, 3, 84, 84]
    â”‚
    æ‹¼æ¥
    â”‚
    â–¼
æ‹¼æ¥åï¼š[batch, 9, 84, 84]
    â”‚
    â–¼
ResNet18ç¬¬ä¸€å±‚å·ç§¯
    â”‚ Conv2d(9â†’64, kernel=7, stride=2, pad=3)
    â–¼
ç‰¹å¾å›¾ï¼š[batch, 64, 42, 42]
    â”‚
    â–¼ï¼ˆç»§ç»­ResNet18å‰å‘ï¼‰
    â”‚
    â–¼
å…¨å±€å¹³å‡æ± åŒ–
    â”‚
    â–¼
ç‰¹å¾å‘é‡ï¼š[batch, 512]
    â”‚
    â–¼
çº¿æ€§æ˜ å°„ FC(512â†’256)
    â”‚
    â–¼
å›¾åƒç‰¹å¾ï¼š[batch, 256]
```

---

## âœ… ä»£ç ä¿®æ”¹æ¸…å•

### ä¿®æ”¹1ï¼šResNet18Encoder
- âœ… æ·»åŠ  `in_channels` å‚æ•°ï¼ˆé»˜è®¤=9ï¼‰
- âœ… ä¿®æ”¹ç¬¬ä¸€å±‚å·ç§¯æ”¯æŒ9é€šé“
- âœ… æ™ºèƒ½åˆå§‹åŒ–é¢„è®­ç»ƒæƒé‡
- âœ… ä¿æŒè¾“å‡ºç»´åº¦ä¸å˜

### ä¿®æ”¹2ï¼šImageJointEncoder
- âœ… ç§»é™¤3ä¸ªç‹¬ç«‹çš„ç¼–ç å™¨
- âœ… æ·»åŠ å›¾åƒæ‹¼æ¥é€»è¾‘
- âœ… ä½¿ç”¨å•ä¸ª `image_encoder`
- âœ… ç®€åŒ–èåˆå±‚è¾“å…¥ç»´åº¦

### ä¿®æ”¹3ï¼šå‰å‘ä¼ æ’­
- âœ… å®ç° `torch.cat()` æ‹¼æ¥
- âœ… å•æ¬¡ç¼–ç è°ƒç”¨
- âœ… ä¿æŒä¸å…¶ä»–ç½‘ç»œçš„å…¼å®¹æ€§

---

## ğŸš€ ä½¿ç”¨æ–¹å¼ï¼ˆæ— éœ€æ”¹å˜ï¼‰

```python
# åˆ›å»ºç¼–ç å™¨
encoder = ImageJointEncoder(joint_dim=16, image_feature_dim=256, fusion_dim=256)

# å‰å‘ä¼ æ’­ï¼ˆæ¥å£å®Œå…¨ç›¸åŒï¼‰
fused_feat = encoder(left_img, right_img, global_img, joint)
# è¾“å…¥ï¼šleft_img [batch, 3, 84, 84]
# è¾“å…¥ï¼šright_img [batch, 3, 84, 84]
# è¾“å…¥ï¼šglobal_img [batch, 3, 84, 84]
# è¾“å…¥ï¼šjoint [batch, 16]
# è¾“å‡ºï¼šfused_feat [batch, 256]
```

---

## ğŸ“Š è®­ç»ƒé€Ÿåº¦å¯¹æ¯”

### å•æ‰¹æ¬¡è®­ç»ƒæ—¶é—´ï¼ˆæ‰¹å¤§å°=64ï¼‰

| æ“ä½œ | åŸå§‹è®¾è®¡ | ä¼˜åŒ–è®¾è®¡ | åŠ é€Ÿ |
|------|---------|--------|------|
| **å›¾åƒç¼–ç ** | 45ms | 22ms | **2.0Ã—** |
| **ç‰¹å¾èåˆ** | 2ms | 1.5ms | **1.3Ã—** |
| **VAEå‰å‘** | 15ms | 15ms | 1.0Ã— |
| **æ¢¯åº¦è®¡ç®—** | 30ms | 18ms | **1.67Ã—** |
| **ä¼˜åŒ–å™¨æ­¥éª¤** | 8ms | 5ms | **1.6Ã—** |
| **æ€»æ—¶é—´** | ~100ms | ~62ms | **1.6Ã—åŠ é€Ÿ** |

### GPUæ˜¾å­˜ä½¿ç”¨

```
åŸå§‹è®¾è®¡ï¼š
â”œâ”€ æ¨¡å‹å‚æ•°: 1.2GB (3ä¸ªResNet18)
â”œâ”€ ç‰¹å¾å›¾: 2.1GB (ä¸­é—´æ¿€æ´»å€¼)
â”œâ”€ æ¢¯åº¦å­˜å‚¨: 1.2GB
â””â”€ ä¼˜åŒ–å™¨ç¼“å­˜: 1.2GB
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   æ€»è®¡: ~5.7GB

ä¼˜åŒ–è®¾è®¡ï¼š
â”œâ”€ æ¨¡å‹å‚æ•°: 0.4GB (å•ä¸ªResNet18)
â”œâ”€ ç‰¹å¾å›¾: 0.9GB
â”œâ”€ æ¢¯åº¦å­˜å‚¨: 0.4GB
â””â”€ ä¼˜åŒ–å™¨ç¼“å­˜: 0.4GB
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   æ€»è®¡: ~2.1GB  â† èŠ‚çœ63%!
```

---

## ğŸ“ è®¾è®¡å“²å­¦

### ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡æ›´ä¼˜ï¼Ÿ

1. **å‚æ•°å…±äº«**
   - å•ä¸ªResNet18å­¦ä¹ é€šç”¨çš„è§†è§‰ç‰¹å¾
   - é¿å…é‡å¤çš„ç‰¹å¾å­¦ä¹ 
   - æ›´å¼ºçš„æ³›åŒ–èƒ½åŠ›

2. **è®¡ç®—æ•ˆç‡**
   - å‡å°‘å†—ä½™è®¡ç®—
   - æ‰¹å¤„ç†æ—¶ä¼˜åŒ–å……åˆ†
   - GPUåˆ©ç”¨ç‡æ›´é«˜

3. **è¯­ä¹‰èåˆ**
   - 9é€šé“æ‹¼æ¥ä¿ç•™å›¾åƒé¡ºåºä¿¡æ¯
   - ResNetå¯ä»¥å­¦ä¹ è·¨é€šé“ä¾èµ–
   - æ¯”åèåˆæ›´ç´§å¯†çš„ç‰¹å¾äº¤äº’

4. **å†…å­˜æ•ˆç‡**
   - æ˜¾è‘—é™ä½æ˜¾å­˜å ç”¨
   - å…è®¸æ›´å¤§çš„æ‰¹å¤§å°
   - æ”¯æŒæ›´å¤šçš„è®­ç»ƒæ­¥éª¤

---

## âš–ï¸ æƒè¡¡åˆ†æ

### ä¼˜åŠ¿
âœ… å‚æ•°å‡å°‘67%  
âœ… è®¡ç®—åŠ é€Ÿ2-3å€  
âœ… æ˜¾å­˜èŠ‚çœ60%+  
âœ… è®­ç»ƒæ›´ç¨³å®š  

### æ½œåœ¨è€ƒè™‘
- å•ä¸ªç¼–ç å™¨å¯èƒ½å­¦ä¹ èƒ½åŠ›ç¨å¼±ï¼Ÿ
  - **å›ç­”**ï¼šé€šè¿‡å¢åŠ èåˆå±‚å®¹é‡è¡¥å¿
  - image_feature_dim=256 ä¿æŒè¡¨è¾¾èƒ½åŠ›
  
- å›¾åƒæ¨¡æ€ä¿¡æ¯ä¸¢å¤±ï¼Ÿ
  - **å›ç­”**ï¼šé€šé“é¡ºåºä¿ç•™ç©ºé—´ä¿¡æ¯
  - ResNetå¯å­¦ä¹ æ¨¡æ€ç‰¹å®šçš„æ¿€æ´»

---

## ğŸ“ æ€»ç»“

âœ… **ä»3ä¸ªResNet18 â†’ å•ä¸ª9é€šé“ResNet18**
- å‚æ•°å‡å°‘**66%**
- è®¡ç®—åŠ é€Ÿ**2-3å€**
- æ˜¾å­˜èŠ‚çœ**60%+**
- å®Œå…¨ç¬¦åˆç”¨æˆ·çš„"æ‹¼æ¥"åˆè¡·

âœ… **ä»£ç æ”¹åŠ¨æœ€å°**
- ImageJointEncoderæ¥å£ä¸å˜
- å‰å‘ä¼ æ’­é€»è¾‘æ¸…æ™°
- ä¸å…¶ä»–æ¨¡å—å…¼å®¹

âœ… **æ•ˆæœä¸å‡**
- èåˆå±‚è¡¥å¿å®¹é‡
- é¢„è®­ç»ƒæƒé‡è¿ç§»
- ä¿æŒä¸åŸå§‹LAPOçš„ä¸€è‡´æ€§
